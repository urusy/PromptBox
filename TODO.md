# TODO

## 未着手

（なし）

## AI提案機能(未精査)

- [ ] ComfyUIへの直接送信
  - **実装方針**: ComfyUI APIを使って画像やワークフローを送信
  - **処理内容**:
    - 画像をimg2imgの入力として送信
    - 保存したワークフローをComfyUIにロード
    - ComfyUIのエンドポイントURL設定
  - **工数目安**: 中（ComfyUI API連携）
  - **前提**: ComfyUIがローカルで稼働していること

- [ ] 画像のクラウドバックアップ連携（Google Drive、Cloudflare R2等）
  - **実装方針**: OAuth認証でクラウドストレージAPI連携、選択画像をアップロード
  - **修正ファイル**:
    - `backend/app/services/cloud_backup_service.py` (新規): クラウドAPI連携
    - `backend/app/api/endpoints/backup.py` (新規): バックアップAPI
    - `frontend/src/pages/SettingsPage.tsx`: クラウド連携設定UI
    - `frontend/src/components/gallery/SelectionToolbar.tsx`: バックアップボタン追加
  - **処理内容**:
    - Google Drive / Dropbox等のOAuth認証フロー
    - 選択画像を指定フォルダにアップロード
    - バックアップ履歴の管理
  - **工数目安**: 大（OAuth実装、各クラウドAPI対応）
  - **セキュリティ**: アクセストークンの安全な保存が必要

## 見送り（検討済み）

以下は検討の結果、現時点では実装しないと判断した機能。将来必要になった場合に再検討。

- [ ] DDD/クリーンアーキテクチャへのリファクタリング
  - **検討日**: 2024-12-13
  - **見送り理由**:
    1. シンプルなCRUD中心のドメインに過剰な抽象化
    2. 単一ユーザーアプリに複雑なアーキテクチャは不要
    3. 現状のレイヤード構造（API/Service/Model）で十分機能
  - **再検討条件**: マルチユーザー対応、複雑なビジネスロジック追加時

## 完了済み

### 最近の更新

- [x] 画像取り込み時にファイルの作成日を生成日として使用
  - ファイルの作成日時（birthtime）を`created_at`に設定
  - birthtimeが利用不可の場合は更新日時（mtime）にフォールバック
- [x] バックエンドやDBのリソース増強
  - PostgreSQL: shared_buffers 128MB→256MB, effective_cache_size 256MB→512MB
  - PostgreSQL: work_mem 16MB→32MB, maintenance_work_mem 64MB→128MB
  - PostgreSQL: max_connections 50→100, wal_buffers追加, random_page_cost最適化
  - バックエンド接続プール: pool_size 5→10, max_overflow 10→20
  - pool_pre_ping, pool_recycle追加（接続の健全性チェック）
  - Dockerリソース制限: バックエンド最大1GB, DB最大1GB
- [x] Playwright MCP E2Eテスト環境構築
  - E2Eテスト設計書（docs/07_e2e_testing.md）
  - 15カテゴリ、約50テストシナリオを定義
  - セットアップスクリプト（scripts/setup-e2e.sh）
  - `/e2e-test` スラッシュコマンドを追加
- [x] Quick Rate（Tinder風UI）機能を追加
  - 未評価画像を素早く評価するためのスワイプUI
  - 左スワイプ: スキップ、右スワイプ: お気に入り（★5）
  - キーボードショートカット: 1-5で評価、F/S/Iでアクション
  - タッチジェスチャーとスワイプアニメーション
  - プログレスバーと戻る（Undo）機能
- [x] タグフィルター（AND条件での複数タグ選択）を追加
  - 検索フォームにマルチタグフィルターUIを追加
  - ドロップダウンからタグを検索・選択可能
  - 選択したタグはバッジ表示で削除可能
- [x] Model/LoRA一覧・詳細ページを追加
  - Models一覧ページ（/models）: 検索、タイプ/画像数/評価フィルター、ソート
  - LoRAs一覧ページ（/loras）: 同様の機能
  - Model詳細ページ: 統計、評価分布グラフ、Top Samplers/LoRAs
  - LoRA詳細ページ: 統計、平均Weight、Top Models/Samplers
  - 表示名は`\`以降の部分を使用
- [x] CivitAI連携 - モデル/LoRA情報をCivitAIから自動取得
  - Model/LoRA詳細ページにCivitAI情報セクションを追加
  - CivitAI API（/api/v1/models、/model-versions/by-hash）を使用
  - 画像、推奨設定（Clip Skip, Steps, CFG, Sampler等）を表示
  - 完全一致→あいまい検索のフォールバック（警告バッジ付き）
  - インメモリキャッシュ（TTL: 24時間）
  - NSFW画像も取得・表示
- [x] iPhoneのSafe Area対応（上部メニュー見切れ修正）
  - `viewport-fit=cover` を追加
  - ヘッダーに `env(safe-area-inset-top/left/right)` padding追加
  - メインコンテンツに左右・下部のSafe Area padding追加
- [x] Showcase画像のドラッグ&ドロップ並び替え機能
  - @dnd-kit ライブラリを導入
  - SortableImageGrid コンポーネントを新規作成
  - Showcase詳細画面に「並び替え」ボタンを追加
  - ドラッグ操作で画像の順序を変更、自動保存（楽観的更新）
  - バックエンドAPI（reorder）は既存実装を活用
  - タッチデバイス対応（TouchSensor、iOS拡大鏡無効化）
- [x] 検索フィルターにOrientation（Portrait/Landscape/Square）を追加
  - バックエンド: width/heightの比較でフィルタリング
  - フロントエンド: ドロップダウンで選択
- [x] 検索フォームUIのレイアウト改善（使いやすさ向上）
  - Row 1: 生成ソース（Source Tool, Model Type, Model Name, Sampler）
  - Row 2: 追加フィルター（LoRA, Orientation, Grid, Upscale）
  - Row 3: 評価・時間（Rating + 未評価, Favorites, Date Range）
  - Row 4: サイズ・ソート（Min Size, Sort By, Order）
  - RatingとUnrated（未評価）を同一グループに統合
  - 関連するフィルターをグループ化して直感的に操作可能
- [x] セキュリティ観点からMinIO導入を検討
  - 結論: 現時点では不要
  - 理由: 既存セキュリティ実装で十分（パストラバーサル対策、ハッシュベース命名）、単一ユーザーアプリにS3 APIは過剰
  - 再検討条件: マルチユーザー対応、クラウド移行時
- [x] Showcaseカバー画像選択機能
  - 編集モーダルにカバー画像選択UIを追加
  - Showcase内の画像から選択可能
  - 「カバーなし」オプションも選択可能
- [x] 検索フィルター追加（Sampler / Date Range / Unrated）
  - Sampler: ドロップダウンで選択可能（バックエンドは既存、UIを追加）
  - Date Range: Today / Past 7 Days / Past 30 Days / This Month のクイックフィルター
  - Unrated: 未評価画像のみ表示するトグルボタン
  - バックエンド: date_fromパラメータ、/stats/samplers-for-filter API追加
- [x] 検索フォームのUI改善
  - レイアウトをカテゴリ別に整理（モデル/生成 → 品質/属性 → サイズ/ソート）
  - Min Width / Min Height を統合して横並び表示
  - Favoritesをチェックボックスからトグルボタンに変更
  - Model Name / LoRAにクリアボタン（×）を追加
- [x] 検索条件にLoRAフィルターを追加
  - LoRA名でフィルタリング可能に
  - Model Nameと同様のコンボボックス形式（テキスト入力+ドロップダウン）
  - バックエンド: `/stats/loras-for-filter` APIを追加
  - JSONB containmentクエリのバグ修正（type_coerce使用）
- [x] ESLint設定を追加、コード警告を修正
  - ESLint v9 Flat Config形式で設定ファイル追加
  - 未使用変数の警告を修正
  - RATING_LABELS定数を別ファイルに移動（Fast Refresh警告対応）
  - package.jsonのlintスクリプトを更新
- [x] Showcase機能（コレクション/アルバム）を追加
  - 画像をカスタムコレクション（Showcase）に整理
  - Showcase作成・編集・削除
  - ギャラリーの選択ツールバーからShowcaseに画像追加
  - **詳細画面からも画像をShowcaseに追加可能**
  - **追加済み画像の重複チェック・表示**（追加済みのShowcaseは選択不可）
  - Showcase詳細ページで画像一覧・削除
  - **スライドショー機能**（自動再生、シャッフル、キーボードショートカット）
  - ヘッダーにShowcaseリンクを配置（ロゴの右側）
- [x] 日毎の更新操作量グラフを追加（統計ページ）
  - レーティング変更やお気に入り登録など、更新操作を行った画像数を日別に表示
  - Daily Importsグラフと同様のデザインで横並び表示
  - バックエンド: `updated_at > created_at`の画像をカウント
- [x] バックエンドパフォーマンス最適化
  - タグリストのキャッシング（TTL: 5分）
  - 統計データのキャッシング（TTL: 10分）
  - Prev/Nextクエリの並列実行（asyncio.gather）
  - ワーカーのセッションファクトリキャッシュ
  - 非同期サムネイル生成（ThreadPoolExecutor）
- [x] iOS/iPadアプリ向けSwiftUI設計ドキュメント作成 (docs/09_ios_app_design.md)
  - MVVM + SwiftUIアーキテクチャ
  - Webアプリと同等の機能を網羅
  - iPad Split View対応設計
  - キーボードショートカット対応
- [x] 検索フィルターのモデル名入力をコンボボックス化
  - テキスト入力とリスト選択の両方に対応
  - モデル名はバックスラッシュ以降のみ表示
  - アルファベット順にソート、重複除去
- [x] 一括操作の上限を100件から500件に増加
- [x] 一括操作のURLを/batch/から/bulk/に変更（広告ブロッカー対策）
- [x] 大量画像インポート時のイベント取りこぼし対策（短期対策）
  - 定期的なフォルダスキャン追加（30秒ごとに未処理ファイルを検出・処理）
  - DBプールサイズ増加（pool_size=2→5, max_overflow=3→10）
  - watchdogイベント取りこぼし時も確実にファイルを処理
- [x] 分析画面にモデル×レーティング分布グラフを追加
  - 縦軸にモデル名、横軸に平均レーティング（★0〜★5）の横棒グラフ
  - Top Modelsと同じスタイルで統一感のあるデザイン
- [x] 一覧の表示領域(横幅)を拡大
  - 幅制限を撤廃し全画面幅を使用
- [x] ギャラリー設定のLocalStorage保存
  - 表示件数（24/48/72/96/120）をドロップダウンで変更可能
  - グリッドサイズ設定もLocalStorageに保存
  - 設定はブラウザごとに永続化
- [x] 高解像度ディスプレイ向けレスポンシブ対応
  - 3xl (1920px)、4xl (2560px)、5xl (3840px) ブレークポイント追加
  - 画像グリッドの列数を高解像度に最適化
- [x] 評価傾向分析にモデル別分析機能を追加
  - 「Overall」タブと各モデルタブで切り替え
  - モデルタブは平均評価の高い順（Best Modelsと同じ順序）で左から表示
  - モデルを選択すると、そのモデルに最適なSampler/LoRA/Steps/CFGを表示
  - 選択中のモデル名を明示的に表示
- [x] 評価傾向分析機能を追加
  - 設定値（モデル/LoRA/Sampler/Steps/CFG）ごとの平均評価を表示
  - 高評価画像の多い設定をランキング形式で表示
  - 統計ページの「Rating Analysis」セクションとして実装
- [x] 使用統計ダッシュボード機能を追加
  - /stats ページで統計情報を表示
  - 概要: 総画像数、お気に入り数、評価済み数、未評価数、平均評価
  - Model Type / Source Tool の分布（円グラフ）
  - Rating分布（棒グラフ）
  - Top Models / Samplers / LoRAs（横棒グラフ）
  - 日次生成数推移（折れ線グラフ、30日間）
  - Rechartsライブラリを導入
- [x] ログアウトボタンをユーザーメニューに移動
  - ユーザー名クリックでドロップダウンメニュー表示
  - メニュー内にLogoutボタン配置
- [x] 一覧を開いたときにプリセットが選択状態になる問題を修正
  - フィルター条件がない初期状態ではプリセット選択を行わないよう修正
- [x] スマートフォルダ機能を追加
  - 検索条件を保存し、動的に該当画像を表示する仮想フォルダ
  - フォルダ一覧ページ（/smart-folders）を追加
  - フォルダクリックでギャラリーページにフィルター適用して遷移
  - フォルダの作成・編集・削除機能
  - ナビゲーションにSmartリンク追加
- [x] プリセット選択時に適用中のプリセットがわかる表示を追加
  - プリセットボタンに選択中のプリセット名を表示
  - ボタンの背景色を青色に変更（選択中）
  - ドロップダウン内で選択中のプリセットをハイライト
  - 検索条件が変更されプリセットと一致しなくなると自動でクリア
- [x] タグ追加時に使用済みタグ候補を表示する機能追加
  - 最近使用したタグを最大10個表示
  - 候補から選択してタグを追加可能に
  - キーボード操作（↑↓キー、Enter）対応
- [x] プリセット選択時のnull値によるエラー修正
  - APIレスポンスの`null`値が`toSearchParams`でエラーを起こす問題を修正
- [x] 更新日時（Date Updated）でのソート機能追加
- [x] 検索条件の保存・呼び出し機能 - よく使う検索条件をプリセットとして保存
  - DB永続化によるプリセット管理
  - 検索フォームにドロップダウンUI追加
  - プリセットの作成・削除機能
  - プリセット選択時のURL同期
- [x] 詳細画面でfキーでお気に入り、cキーで改善対象のトグル
- [x] 選択ツールバーの改善 - Selectボタン押下で即表示、未選択時は操作ボタン非活性
- [x] 検索フォームUIの改善 - フィルター開閉ボタンと条件削除ボタンの配置変更
- [x] 詳細画面で数字キー(0-5)によるレーティング設定機能追加
- [x] 詳細画面の前後ナビゲーション修正 - 検索条件を維持して遷移・戻り
- [x] レーティングフィルターUIの改善 - 「Any」と「★0 (Unrated)」を分離
- [x] スライドショー機能 - 検索結果を自動再生するフルスクリーンモード
- [x] ログイン後に元の検索条件付き画面へリダイレクトする機能追加
- [x] キーボードナビゲーション - 詳細画面で←→キーで前後の画像へ移動
- [x] 詳細画面の画像拡大表示でEscキーで閉じるキーバインド追加
- [x] 画面下部の選択メニューのモバイル対応（見切れ修正）
- [x] レーティングの日本語ツールチップ追加
- [x] 検索条件追加: Upscale、最小Width/Height、レーティング同等/以上
- [x] 検索条件をURLクエリパラメータに保存
- [x] デプロイメントガイド作成 (docs/07_deployment.md)
- [x] NAS本番用docker-compose.prod.yml追加

### 過去の実装

- [x] UI改善とメタデータパース修正
- [x] ローカルネットワークアクセス対応（モバイル向け）
- [x] アプリ名変更: ComfyUI Gallery → Prompt Box
- [x] XYZ Grid画像対応 (A1111/Forge)
- [x] 重複画像管理ページ追加
- [x] Hires Upscaler検出・表示
- [x] 画像インポート・ストレージ問題修正
- [x] Dockerビルド問題修正
- [x] Phase 4: 拡張機能（評価・タグ・一括操作・エクスポート・ゴミ箱）
- [x] Phase 3: UI強化（一覧・詳細・検索）
- [x] Phase 2: メタデータパーサー・画像ウォッチャー
- [x] Phase 1: 基盤構築（Docker・FastAPI・DB・認証）
