# E2Eテスト設計書

## 概要

Playwright MCPを使用したE2Eテストの設計と実行手順。

## セットアップ

### 前提条件

- Node.js 18以上
- Claude Code CLI

### インストール手順

```bash
# 1. Playwrightブラウザをインストール
npx playwright install

# 2. Claude CodeにPlaywright MCPを追加
claude mcp add playwright -- npx @playwright/mcp@latest

# 3. 設定確認
claude mcp list
```

### 設定ファイル

`~/.claude.json` に以下が追加されます：

```json
{
  "mcpServers": {
    "playwright": {
      "command": "npx",
      "args": ["@playwright/mcp@latest"]
    }
  }
}
```

## テスト実行方法

### Claude Code内での実行

```bash
# Claude Codeを起動
claude

# MCPツールを確認
/mcp

# テスト実行例
「playwright mcpを使用して http://localhost:3000 を開いて」
```

### 利用可能なPlaywright MCPツール

| ツール | 説明 |
|--------|------|
| `browser_navigate` | URLに移動 |
| `browser_click` | 要素をクリック |
| `browser_type` | テキストを入力 |
| `browser_snapshot` | ページのアクセシビリティスナップショットを取得 |
| `browser_screenshot` | スクリーンショットを保存 |
| `browser_wait` | 指定時間待機 |

## テストシナリオ

### 1. 認証フロー

#### 1.1 ログイン成功
```
1. http://localhost:3000/login にアクセス
2. ユーザー名を入力
3. パスワードを入力
4. ログインボタンをクリック
5. ギャラリーページにリダイレクトされることを確認
```

#### 1.2 ログイン失敗
```
1. http://localhost:3000/login にアクセス
2. 不正な認証情報を入力
3. エラーメッセージが表示されることを確認
```

#### 1.3 ログアウト
```
1. ログイン状態でヘッダーのユーザーメニューをクリック
2. ログアウトをクリック
3. ログインページにリダイレクトされることを確認
```

### 2. 画像ギャラリー

#### 2.1 画像一覧表示
```
1. http://localhost:3000 にアクセス
2. 画像グリッドが表示されることを確認
3. 画像にサムネイルが表示されることを確認
```

#### 2.2 検索・フィルター
```
1. 検索フォームを開く
2. プロンプト検索語を入力
3. 検索ボタンをクリック
4. フィルターされた結果が表示されることを確認
```

#### 2.3 評価フィルター
```
1. 評価フィルターで「★4以上」を選択
2. 表示される画像がすべて★4以上であることを確認
```

#### 2.4 タグフィルター
```
1. タグフィルターを開く
2. タグを複数選択
3. AND条件で画像がフィルターされることを確認
```

#### 2.5 ソート
```
1. ソートを「評価順」に変更
2. 画像が評価の高い順に並ぶことを確認
```

### 3. 画像詳細

#### 3.1 詳細表示
```
1. 画像をクリック
2. 詳細ページが表示されることを確認
3. メタデータ（プロンプト、モデル等）が表示されることを確認
```

#### 3.2 評価設定
```
1. 詳細ページで評価ボタンをクリック
2. ★3を選択
3. 評価が保存されることを確認
```

#### 3.3 タグ追加
```
1. タグ入力欄にタグ名を入力
2. Enterで追加
3. タグが画像に追加されることを確認
```

#### 3.4 ナビゲーション
```
1. 詳細ページで「次へ」ボタンをクリック
2. 次の画像が表示されることを確認
3. 「前へ」ボタンで戻れることを確認
```

### 4. Quick Rate（Tinder風UI）

#### 4.1 基本操作
```
1. http://localhost:3000/swipe にアクセス
2. 未評価画像が表示されることを確認
3. プログレスバーが表示されることを確認
```

#### 4.2 キーボード操作
```
1. 数字キー「5」を押す
2. 画像に★5が設定されることを確認
3. 次の画像に自動遷移することを確認
```

#### 4.3 ボタン操作
```
1. お気に入りボタン（ハート）をクリック
2. ★5が設定されることを確認
```

### 5. Models/LoRAs

#### 5.1 モデル一覧
```
1. http://localhost:3000/models にアクセス
2. モデル一覧が表示されることを確認
3. 各モデルの画像数・評価が表示されることを確認
```

#### 5.2 モデル詳細
```
1. モデルをクリック
2. 詳細ページが表示されることを確認
3. CivitAI情報セクションが表示されることを確認
```

#### 5.3 CivitAI情報取得
```
1. CivitAI情報がローディング中表示されることを確認
2. 情報取得後、画像・推奨設定が表示されることを確認
3. CivitAIリンクが正しいことを確認
```

### 6. Showcase

#### 6.1 Showcase作成
```
1. http://localhost:3000/showcases にアクセス
2. 「新規作成」ボタンをクリック
3. タイトルを入力
4. 画像を選択
5. 作成完了を確認
```

#### 6.2 画像並び替え（D&D）
```
1. Showcase編集モードに入る
2. 画像をドラッグ
3. 別の位置にドロップ
4. 順序が変更されることを確認
5. 保存後も順序が維持されることを確認
```

### 7. モバイル対応

#### 7.1 レスポンシブ表示
```
1. ビューポートを375x667（iPhone SE）に設定
2. ヘッダーが正しく表示されることを確認
3. Safe Areaが適用されることを確認
```

#### 7.2 タッチ操作
```
1. Quick Rateページでスワイプ操作
2. 左スワイプでスキップされることを確認
3. 右スワイプでお気に入りされることを確認
```

### 8. ゴミ箱

#### 8.1 ゴミ箱表示
```
1. http://localhost:3000/trash にアクセス
2. 削除済み画像一覧が表示されることを確認
3. 削除日時が表示されることを確認
```

#### 8.2 画像の復元
```
1. ゴミ箱内の画像を選択
2. 「復元」ボタンをクリック
3. 画像がギャラリーに戻ることを確認
```

#### 8.3 完全削除
```
1. ゴミ箱内の画像を選択
2. 「完全に削除」ボタンをクリック
3. 確認ダイアログが表示されることを確認
4. 削除後、画像が完全に消えることを確認
```

#### 8.4 ゴミ箱を空にする
```
1. 「ゴミ箱を空にする」ボタンをクリック
2. 確認ダイアログが表示されることを確認
3. すべての画像が完全削除されることを確認
```

### 9. 重複検出

#### 9.1 重複一覧表示
```
1. http://localhost:3000/duplicates にアクセス
2. 重複グループが表示されることを確認
3. 各グループに類似画像が含まれることを確認
```

#### 9.2 重複の解決
```
1. 重複グループを展開
2. 保持する画像を選択
3. 他の画像を削除
4. グループが解決済みになることを確認
```

### 10. スマートフォルダ

#### 10.1 スマートフォルダ一覧
```
1. http://localhost:3000/smart-folders にアクセス
2. スマートフォルダ一覧が表示されることを確認
3. 各フォルダの画像数が表示されることを確認
```

#### 10.2 スマートフォルダ作成
```
1. 「新規作成」ボタンをクリック
2. フォルダ名を入力
3. フィルター条件を設定（例：★4以上）
4. 保存をクリック
5. フォルダが作成されることを確認
```

#### 10.3 スマートフォルダ表示
```
1. スマートフォルダをクリック
2. 条件に合致する画像のみ表示されることを確認
```

#### 10.4 スマートフォルダ編集・削除
```
1. スマートフォルダの編集ボタンをクリック
2. 条件を変更して保存
3. 削除ボタンでフォルダを削除できることを確認
```

### 11. 統計ページ

#### 11.1 統計概要表示
```
1. http://localhost:3000/stats にアクセス
2. 総画像数、評価済み数等の概要が表示されることを確認
```

#### 11.2 評価分布グラフ
```
1. 評価分布の棒グラフが表示されることを確認
2. 各評価の件数が正しいことを確認
```

#### 11.3 時系列グラフ
```
1. 日別/月別の生成数グラフが表示されることを確認
2. 期間選択で表示が変わることを確認
```

#### 11.4 モデル/サンプラー統計
```
1. 使用モデルランキングが表示されることを確認
2. サンプラー使用統計が表示されることを確認
```

### 12. 検索プリセット

#### 12.1 プリセット保存
```
1. ギャラリーで検索条件を設定
2. 「プリセットとして保存」をクリック
3. プリセット名を入力して保存
4. プリセットが作成されることを確認
```

#### 12.2 プリセット適用
```
1. プリセット一覧からプリセットを選択
2. 保存した検索条件が適用されることを確認
```

#### 12.3 プリセット削除
```
1. プリセットの削除ボタンをクリック
2. プリセットが削除されることを確認
```

### 13. 一括操作

#### 13.1 複数選択
```
1. ギャラリーで選択モードに入る
2. 複数の画像をクリックして選択
3. 選択数が表示されることを確認
```

#### 13.2 一括評価
```
1. 複数画像を選択
2. 「一括評価」で★4を選択
3. 選択したすべての画像に★4が設定されることを確認
```

#### 13.3 一括タグ付け
```
1. 複数画像を選択
2. 「一括タグ」でタグを入力
3. 選択したすべての画像にタグが追加されることを確認
```

#### 13.4 一括削除
```
1. 複数画像を選択
2. 「削除」ボタンをクリック
3. 確認後、選択した画像がゴミ箱に移動することを確認
```

### 14. エクスポート

#### 14.1 単一画像エクスポート
```
1. 画像詳細ページでエクスポートボタンをクリック
2. エクスポート形式を選択（PNG/メタデータ付き）
3. ファイルがダウンロードされることを確認
```

#### 14.2 一括エクスポート
```
1. 複数画像を選択
2. 「エクスポート」をクリック
3. ZIP形式でダウンロードされることを確認
```

### 15. 追加フィルターテスト

#### 15.1 Orientationフィルター
```
1. 検索フォームでOrientation「Portrait」を選択
2. 縦長画像のみ表示されることを確認
3. 「Landscape」で横長画像のみ表示されることを確認
4. 「Square」で正方形画像のみ表示されることを確認
```

#### 15.2 日付範囲フィルター
```
1. 開始日と終了日を設定
2. 指定期間内の画像のみ表示されることを確認
```

#### 15.3 Samplerフィルター
```
1. Samplerドロップダウンから「Euler a」を選択
2. 該当Samplerで生成された画像のみ表示されることを確認
```

#### 15.4 未評価フィルター
```
1. 「未評価のみ」チェックボックスをオン
2. 評価が設定されていない画像のみ表示されることを確認
```

#### 15.5 モデル名フィルター
```
1. モデル名フィルターにモデル名を入力
2. 該当モデルで生成された画像のみ表示されることを確認
```

#### 15.6 LoRAフィルター
```
1. LoRAフィルターにLoRA名を入力
2. 該当LoRAを使用した画像のみ表示されることを確認
```

## テスト結果記録

### 結果フォーマット

```markdown
## テスト実行日: YYYY-MM-DD

### 環境
- OS:
- Browser:
- App Version:

### 結果サマリー
- 合格: X件
- 不合格: X件
- スキップ: X件

### 詳細
| シナリオ | 結果 | 備考 |
|----------|------|------|
| 1.1 ログイン成功 | ✅ | |
| 1.2 ログイン失敗 | ✅ | |
| ... | | |
```

## 注意事項

1. **認証が必要なテスト**
   - Playwright MCPは可視ブラウザを使用
   - 手動でログインしてからテスト続行可能

2. **データ依存性**
   - テストデータが存在する環境で実行
   - 画像がimportされていることを確認

3. **ネットワーク**
   - CivitAI情報取得テストはインターネット接続が必要
   - タイムアウトに注意

## 今後の拡張

- [ ] CI/CD用の通常Playwrightスクリプト作成
- [ ] テストデータのセットアップスクリプト
- [ ] 視覚的回帰テスト
- [ ] パフォーマンステスト
