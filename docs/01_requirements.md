# Prompt Box - 要件定義書

## プロジェクト概要

ComfyUIやStable Diffusionで生成した画像を管理するウェブアプリケーション。
自動取り込み、メタデータ抽出、検索、評価、タグ付けなどの機能を提供する。

## 対象ユーザー

- 1名（シングルユーザー）
- AI画像生成（ComfyUI、Stable Diffusion）を日常的に使用

## 対応モデル

- SD1.5系
- SDXL系（Pony、Illustrious含む）
- Flux.1
- Qwen-Image
- その他（メタデータなし画像も対応）

---

## 機能要件

### FR-01: 自動取り込み

| 項目 | 仕様 |
|------|------|
| 監視対象 | 設定可能なフォルダパス（デフォルト: `/app/import`） |
| 対象ファイル | `*.png` のみ |
| 監視方式 | watchdog（ファイル作成完了検知） |
| 重複チェック | ファイルハッシュ（SHA-256）で判定、重複時はスキップ |
| エラー時 | ログ出力、エラーフォルダへ移動 |

### FR-02: サムネイル生成

| 項目 | 仕様 |
|------|------|
| サイズ | 300×300（アスペクト比維持、はみ出し部分クロップ） |
| 形式 | WebP |
| 品質 | 85% |

### FR-03: ファイル管理

| 項目 | 仕様 |
|------|------|
| ファイル名 | UUID v7 |
| 保存パス | `/storage/{uuid[0:2]}/{uuid[2:4]}/{uuid}.png` |
| サムネイルパス | `/storage/{uuid[0:2]}/{uuid[2:4]}/{uuid}_thumb.webp` |

### FR-04: メタデータ検索

| 検索項目 | 検索方式 |
|----------|----------|
| プロンプト（positive/negative） | 部分一致（全文検索） |
| モデル名 | 部分一致 |
| モデルタイプ | 完全一致（ドロップダウン） |
| サンプラー | 完全一致（ドロップダウン） |
| ステップ数 | 範囲指定（min/max） |
| CFG | 範囲指定（min/max） |
| 解像度 | 範囲指定または完全一致 |
| 評価 | 以上/以下/等しい |
| ユーザータグ | 複数選択AND |
| 改善対象フラグ | ON/OFF |
| ソースツール | 完全一致（ドロップダウン） |
| 削除状態 | 表示/非表示切り替え |

**複数条件指定時は全てAND結合**

### FR-05: 一覧表示

| 項目 | 仕様 |
|------|------|
| レイアウト | グリッド（レスポンシブ、1〜6列） |
| 1ページあたり | 24件（設定変更可能: 12/24/48/96） |
| ページネーション | ページ番号表示、前後移動、先頭/末尾移動 |
| ソート | 作成日時降順（デフォルト）、評価順、ファイルサイズ順 |
| カード表示内容 | サムネイル、★評価、モデル名（ホバー時） |
| 選択機能 | チェックボックスによる複数選択（一括操作用） |
| モバイル対応 | 検索フォーム折りたたみ、タッチ操作対応 |

### FR-06: 詳細表示

| 項目 | 仕様 |
|------|------|
| 画像表示 | オリジナルサイズ表示、ズーム機能 |
| メタデータ表示 | 主要項目の整形表示 + 生JSON折りたたみ表示 |
| 操作 | ★評価、タグ編集、ダウンロード、削除、プロンプトコピー |
| ナビゲーション | 前後画像への移動 |
| レイアウト | レスポンシブ（モバイル: 縦積み、デスクトップ: 横並び） |

### FR-07: 評価機能

| 項目 | 仕様 |
|------|------|
| 評価範囲 | 0〜5（0は未評価） |
| 表示 | ★アイコン（塗りつぶし/空） |
| 操作 | クリックで即時更新（楽観的更新） |
| 対応画面 | 一覧画面、詳細画面 |

### FR-08: タグ機能

| 項目 | 仕様 |
|------|------|
| タグ種別 | 自由入力タグ（複数可） |
| 特殊フラグ | 改善対象（`needs_improvement`）、お気に入り（`is_favorite`） |
| 操作 | 追加、削除、一括付与（選択画像に対して） |
| 表示 | タグチップ形式 |

### FR-09: 削除機能

| 段階 | 動作 |
|------|------|
| 論理削除 | `deleted_at`に日時を設定、一覧から非表示 |
| 復元 | `deleted_at`をNULLに戻す |
| 物理削除 | DB削除 + ストレージからファイル削除 |
| ゴミ箱UI | 論理削除済み一覧表示、復元/完全削除操作 |

### FR-10: 一括ダウンロード

| 項目 | 仕様 |
|------|------|
| 対象 | 一覧画面で選択した画像 |
| 形式 | ZIP圧縮 |
| ファイル名 | `export_YYYYMMDD_HHMMSS.zip` |
| 含まれるもの | オリジナル画像のみ（サムネイル除外） |
| 制限 | 最大100枚（超過時は警告） |

### FR-11: 認証

| 項目 | 仕様 |
|------|------|
| 方式 | セッションベース（Cookie） |
| ユーザー | 1名固定（環境変数で設定） |
| パスワード | bcryptハッシュ化 |
| セッション有効期限 | 7日間 |
| 未認証時 | ログイン画面へリダイレクト |

---

## 非機能要件

| 項目 | 仕様 |
|------|------|
| インフラ | docker-compose.ymlで構築 |
| DB | PostgreSQL 16 |
| バックエンド | Python 3.11+ / FastAPI |
| フロントエンド | React 18 / TypeScript / TailwindCSS |
| 対応ブラウザ | Chrome最新版、Safari最新版（macOS/iOS/iPadOS） |
| 対応デバイス | デスクトップ、iPad Pro 11インチ、iPhone |
| レイアウト | レスポンシブ（モバイルファースト） |

---

## レスポンシブ対応

### ブレークポイント

| 名称 | 幅 | 対象デバイス | グリッド列数 |
|------|-----|-------------|-------------|
| default | 〜639px | iPhone縦向き | 1列 |
| sm | 640px〜 | iPhone横向き | 2列 |
| md | 768px〜 | iPad縦向き | 3列 |
| lg | 1024px〜 | iPad Pro横向き | 4列 |
| xl | 1280px〜 | デスクトップ | 5列 |
| 2xl | 1536px〜 | 大型モニター | 6列 |

### Safari固有の考慮事項

- 100vh問題: `dvh`使用
- input zoom: フォントサイズ16px以上
- Safe Area: `env(safe-area-inset-*)`で対応
- タッチ操作: ホバー依存UIを避ける
